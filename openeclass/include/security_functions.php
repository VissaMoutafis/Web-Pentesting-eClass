<?php

function getXSSToken() {
    $nonce = $_SESSION['uid'].sha1(rand()+3);
    return $nonce;
}

function getCSRFToken() {
    $nonce = $_SESSION['uid'].sha1(rand()+2);

    if (empty($_SESSION['csrf_tokens'])) {
        $_SESSION['csrf_tokens'] = array();
    }
    $_SESSION['csrf_tokens'][$nonce] = true;
    return $nonce;
}


function validateCSRFToken($token) {
    if (isset($_SESSION['csrf_tokens'][$token])) {
        unset($_SESSION['csrf_tokens'][$token]);
        return true;
    }
    return false;
}

function validateCSRFTokenOrDie() {
  //Validate Form
  $token = isset($_POST['csrf_token']) ? $_POST['csrf_token'] : '';
  $valid = !empty($token) && validateCSRFToken($token);
  if (!$valid) {
    printPageOfDeath();
    exit();
  }
  return true;
}

function printPageOfDeath() {
  // Print a random error page, in case of an ambitious attack.
  $val = rand() % 3;

  echo '<style>.center {display: block;margin-left: auto;margin-right: auto;width: 50%;}</style>';

  if ($val == 0) {
    echo '<a href="/images/stalin-meme.jpg" ><img src="/images/stalin-meme.jpg" style="width:50%; height:80%;" class="center"/></a>';
  }
  elseif ($val == 1) {
    echo '<a href="/images/stalin_eclass_vs_attack.jpg" ><img src="/images/stalin_eclass_vs_attack.jpg" style="width:50%; height:80%;" class="center"/></a>';
  }
  else {
    echo '<a href="/images/stalin-gif.gif" ><img src="/images/stalin-gif.gif" style="width:50%; height:80%;" class="center"/></a>';
  }
}